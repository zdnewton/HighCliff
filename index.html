<!DOCTYPE html>
<html lang="en">
<head>
  <title>High Cliff State Park</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />
  
  <!-- Load custom styles, ArcGIS API dark theme, and ArcGIS JavaScript library v4.31 -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/dark/main.css">
  <script src="https://js.arcgis.com/4.31/"></script>
  
<!--CSS to style the map view and position the navigation bar -->
  <style>
    html, body {
      margin: 0;
      height: 100%;
      width: 100%;
    }

    /* Top nav sits above the map */
    #nav {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      background: linear-gradient(180deg,#0b5aa5 0%, #0860a0 100%);
      color: #fff;
      z-index: 9999;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Make the map fill the area below the nav */
    #viewDiv {
      position: absolute;
      top: 64px; /* same as nav height */
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: auto;
    }
  </style>

<script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/layers/ImageryTileLayer",
    "esri/widgets/Locate",
    "esri/widgets/Compass",
    "esri/widgets/ScaleBar",
    "esri/geometry/Extent",
    "esri/renderers/UniqueValueRenderer",
    "esri/widgets/Legend",
    "esri/widgets/Expand",
    "esri/widgets/Home",
    "esri/Basemap",
    "esri/style/WebStyleSymbol"
  ], function(Map, MapView,FeatureLayer,ImageryTileLayer, Locate, Compass, ScaleBar, Extent, UniqueValueRenderer, Legend, Expand, Home, Basemap, WebStyleSymbol) {
    
    // Load basemap from ArcGIS online portal
    const basemap = new Basemap({
      portalItem: {
        id: "dc9d20a9725c4ebaaa84da75a8bb0214",
      }
    });

    // Create the map with the basemap
    var map = new Map({
      basemap: basemap
    });
    
    // Create the map view with center point and initial zoom level
    var view = new MapView({
      container: "viewDiv",
      map: map,
      center: [-88.29300, 44.1541],
      zoom: 14
    });
    
    // Rotate the view 15 degrees for better visual presentation
    view.rotation = -15;
	
    // Load POI feature layer from ArcGIS service
    const POIlayer = new FeatureLayer({ 
        title: "POIs", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/2"
    });

    // Helper function to dynamically create popup templates for a layer
    // Selects a title field from candidates, excludes system fields (geometry, OBJECTID, Season),
    // and includes preferred fields in the popup (max 6 fields)
    function createPopupTemplate(layer, titleCandidates, preferredFields) {
      const excludeRe = /shape|geometry|globalid|objectid|season/i;
      layer.load().then(function() {
        const fields = layer.fields || [];

        // Find the best title field from candidates and preferred fields
        let titleField = null;
        for (let c of (titleCandidates || [])) {
          if (fields.some(f => f.name.toLowerCase() === c.toLowerCase() && !excludeRe.test(f.name))) { 
            titleField = c; 
            break; 
          }
        }
        if (!titleField && preferredFields && preferredFields.length) {
          const pf = preferredFields.find(p => fields.some(f => f.name.toLowerCase() === p.toLowerCase() && !excludeRe.test(f.name)));
          if (pf) titleField = pf;
        }
        if (!titleField) {
          const strField = fields.find(f => !excludeRe.test(f.name) && /char|string|text|name|title|label/i.test(f.type + ' ' + f.name));
          titleField = strField ? strField.name : (fields.find(f => !/objectid|season/i.test(f.name) && /objectid/i.test(f.name)) || {}).name || null;
        }

        // Build a list of fields to show in popup, prioritizing preferred fields and excluding system fields
        const visible = [];
        if (preferredFields && preferredFields.length) {
          for (let p of preferredFields) {
            const f = fields.find(ff => ff.name.toLowerCase() === p.toLowerCase());
            if (f && !excludeRe.test(f.name)) visible.push({ fieldName: f.name, label: f.alias || f.name });
            if (visible.length >= 6) break;
          }
        }
        if (visible.length < 6) {
          for (let f of fields) {
            if (visible.some(v => v.fieldName === f.name)) continue;
            if (excludeRe.test(f.name)) continue;
            visible.push({ fieldName: f.name, label: f.alias || f.name });
            if (visible.length >= 6) break;
          }
        }

        layer.popupTemplate = {
          title: titleField ? `{${titleField}}` : layer.title || "Feature",
          content: [
            {
              type: "fields",
              fieldInfos: visible
            }
          ]
        };
      }).catch(function(err){
        console.warn('Unable to create popup for', layer && layer.title, err);
      });
    }

  // Map of POI type codes to labels and colors for the renderer
    const poiColorMap = {
      0: { label: 'Tower', color: '#6b6b6b' },
      1: { label: 'Picnic Area', color: '#2e8b57' },
      2: { label: 'Pet Picnic Area', color: '#2e8b57' },
      3: { label: 'Playground Equipment', color: '#8a2be2' },
      4: { label: 'Community Fire Ring', color: '#d62728' },
      5: { label: 'Restored Silo', color: '#a0522d' },
      6: { label: 'Flush Toilet', color: '#1f77b4' },
      7: { label: 'Vault Toilet', color: '#1f77b4' },
      8: { label: 'Shower', color: '#00bfff' },
      9: { label: 'Trailer Dumping Station', color: '#ff7f0e' },
      10: { label: 'Water Fountain', color: '#4cc3d9' },
      11: { label: 'Scenic Overlook', color: '#bcbd22' },
      12: { label: 'Emergency Access', color: '#7f0000' }
  };

    // POI Label Symbol
    const poiLabelSymbol = {
      type: "text",
      color: "#333",
      haloColor: "#fff",
      haloSize: "1px",
      font: {
        size: 9,
        family: "Arial"
      }
    };

    // POI Label Class
    const poiLabelClass = {
      symbol: poiLabelSymbol,
      labelExpressionInfo: {
        expression: "$feature.Name"
      }
    };

    POIlayer.load().then(function() {
      // Find the POI type field
      const field = (POIlayer.fields || []).find(f => /type|category|poi|class/i.test(f.name));
      const fieldName = field ? field.name : 'Type';

      // Create unique value infos from the POI color map
      const uniqueInfos = Object.keys(poiColorMap).map(function(key) {
        const info = poiColorMap[key];
        return {
          value: Number(key),
          label: info.label,
          symbol: {
            type: 'simple-marker',
            style: 'circle',
            color: info.color,
            size: '10px',
            outline: { color: '#ffffff', width: 1 }
          }
        };
      });

      const poiRenderer = new UniqueValueRenderer({
        field: fieldName,
        defaultLabel: 'Other POI',
        uniqueValueInfos: uniqueInfos
      });

      // Apply renderer, enable labels, and create popup template for POI layer
      POIlayer.renderer = poiRenderer;
      POIlayer.labelingInfo = [poiLabelClass];
      POIlayer.labelsEnabled = true;
      try { POIlayer.refresh(); } catch (e) { /* ignore if not applicable */ }

      // Create curated popup with Name and Type fields
      createPopupTemplate(POIlayer, ['Name','Label','Title','Type','type'], ['Name','Type','Description','Notes','Label']);
    }).catch(function(err){
      console.error('Error loading POI layer to set color renderer', err);
    });

    const TrailsRenderer = new UniqueValueRenderer({
      field: "TrailType",
      defaultLabel: "Other",
      defaultSymbol: {
        type: "simple-line",
        color: [150, 150, 150, 1],
        width: 1.5
      },
      uniqueValueInfos: [
      {
        value: "0",
        label: "Hiking Trails",
        symbol: {
          type: "simple-line",
          color: [0,255,0,1],
          width: 1.5,
          style: "short-dash"
        },
      },
      {
        value: "1",
        label: "Hiking/Biking Trails",
        symbol: {
          type: "simple-line",
          color: [255,0,0,1],
          width: 1.5,
          style: "short-dash"
        }
      },
      {
        value: "2",
        label: "Horse/Biking Trails",
        symbol: {
          type: "simple-line",
          color: [255,200,0,1],
          width: 1.5,
          style: "short-dash"
        }
      },
      {
        value: "3",
        label: "Cross Country Skiing Trails",
        symbol: {
          type: "simple-line",
          color: [0,0,255,1],
          width: 1.5,
          style: "short-dash"
        }
      },
      {
        value: "4",
        label: "Access Trails",
        symbol: {
          type: "simple-line",
          color: [125,125,125,1],
          width: 1.5,
          style: "short-dash"
        }
      },
      {
        value: "5",
        label: "Snowmobile Trails",
        symbol: {
          type: "simple-line",
          color: [0,0,0,1],
          width: 1.5,
          style: "short-dash"
        }
      }
    ]}
    );

  const TrailLabelSymbol = {
    type: "text",
    color: "black",
    haloColor: "white",
    haloSize: "1px",
    font: {
      size: 9,
      family: "Arial"
    },
    weight: "bold"
  };

  // Label class for trails with spacing and scale constraints
  const TrailLabelClass = {
    symbol: TrailLabelSymbol,
    labelExpressionInfo: {
      expression: "$feature.Name + ' ' + Round($feature.Miles, 2) + ' Mi'"
    },
    labelPlacement: "above-along",
    repeatLabel: false,
    deconflictionStrategy: "dynamic",
    repeatDistance: 1609, // Prevent labels within 1 mile (1609 meters) of each other
    maxScale: 500, // Show labels when zoomed to 1:500 or closer
    minScale: 0 // No minimum scale limit
  };

  // Load Trails feature layer from ArcGIS service with labeling and popup template
  const Trails = new FeatureLayer({
        title: "Trails", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/3",
        renderer: TrailsRenderer,
        outFields: ["*"],
        labelingInfo: [TrailLabelClass],
        labelsEnabled: true,
        popupTemplate: {
          title: "{Name}",
          content: [
            {
              type: "text",
              text: "<b>Type:</b> {TrailType}<br><b>Miles:</b> {expression/milesRounded}"
            }
          ],
          expressionInfos: [
            {
              name: "milesRounded",
              expression: "Round($feature.Miles, 2)"
            }
          ]
        }
    });

    const roadRenderer = new UniqueValueRenderer({
      field: "RoadType",
      defaultLabel: "Other",
      defaultSymbol: {
        type: "simple-line",
        color: [150, 150, 150, 1],
        width: 1.5
      },
      uniqueValueInfos: [
      {
        value: "0",
        label: "Park Roads",
        symbol: {
          type: "simple-line",
          color: [0,0,0,.5],
          width: 2
        },
      },
      {
        value: "1",
        label: "Service Roads",
        symbol: {
          type: "simple-line",
          color: [255,0,0,.25],
          width: 2
        }
      },
      {
        value: "2",
        label: "Campground Roads",
        symbol: {
          type: "simple-line",
          color: [125,125,125,.25],
          width: 2
        }
      },
      {
        value: "4",
        label: "Not Park Roads",
        symbol: {
          type: "simple-line",
          color: [100,100,100,.25],
          width: 2
        }
      }]
    });

    const roadLabelSymbol = {
      type: "text",
      color: "#333",
      haloColor: "#fff",
      haloSize: "1px",
      font: {
        size: 9,
        family: "Arial"
      }
    };

    // Label class for roads (excludes RoadType 4 - Not Park Roads)
    const roadLabelClass = {
      symbol: roadLabelSymbol,
      labelExpressionInfo: {
        expression: "$feature.Name"
      },
      labelPlacement: "above-along",
      where: "RoadType <> 4"
    };

    // Load Roads feature layer from ArcGIS service with labeling
    const Roads = new FeatureLayer({
        title: "Roads", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/ParkRoads_view/FeatureServer",
        renderer: roadRenderer,
        outFields: ["*"],
        labelingInfo: [roadLabelClass],
        labelsEnabled: true
    });
    
    // Referencing a web style via styleName
    const webStyleSymbol = new WebStyleSymbol({
      name: "Fire Response Restrictions - Other",
      styleUrl: "https://cdn.arcgis.com/sharing/rest/content/items/6eeef46c653b40c9bda04f9bed913b70/data"
    });

    const concernRenderer = {
      type: "simple", // autocasts as new SimpleRenderer()
      symbol: webStyleSymbol
    };

    const Concerns = new FeatureLayer({
      titile: "Concern",
      url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/High_Cliff_Report_a_Concern_view/FeatureServer",
      renderer: concernRenderer
    })

    // Define the fill symbol for parking lots (gray with black outline)
    const ParkingfillSymbol = {
      type: "simple-fill",
      color: [128, 128, 128, 0.75],
      outline: {
        color: [0, 0, 0, 0.75],
        width: 0.5
      }
    };

    // Define the renderer for parking lots
    const ParkingRenderer = {
      type: "simple",
      symbol: ParkingfillSymbol
    };

    // Load Parking Lots feature layer from ArcGIS service
    const ParkingLots = new FeatureLayer({
        title: "Parking Lots", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/0",
        renderer: ParkingRenderer      
    });

    // Define the fill symbol for park boundary (transparent with bold purple outline for contrast)
    const ParkfillSymbol = {
      type: "simple-fill",
      style: "none",
      outline: {
        color: [128, 0, 128, 1], // Purple outline
        width: 3
      }
    };
    
    // Define the renderer for park boundary
    const ParkBoundaryRenderer = {
      type: "simple",
      symbol: ParkfillSymbol
    };    
    
    // Load Park Boundary feature layer from ArcGIS service
    const ParkBoundary = new FeatureLayer({
        title: "Park Boundary", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/4",
        renderer: ParkBoundaryRenderer
    });
    
    // Load Structure Polygons feature layer from ArcGIS service
    const StructurePolygon = new FeatureLayer({
        title: "Structure Polygons", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/1"
    });    

    // Create popup template for Structure Polygons with selected fields
    createPopupTemplate(StructurePolygon, ['Name','Title','Label','OBJECTID'], ['Name','Type','Material','YearBuilt','Condition']);
    
    // Create Locate widget to find user's current location
    const locateBtn = new Locate({
      view: view
    });

    // Create Compass widget to display map orientation
    const compass = new Compass({
      view: view
    });

    // Create and add Scale Bar widget showing imperial and metric units
    const scaleBar = new ScaleBar({
      view: view,
      unit: "imperial"
    });
    view.ui.add(scaleBar, "bottom-left");

    // Create Home widget to return to the initial map extent
    const homeBtn = new Home({
      view: view
    });

    // Create Legend widget showing all map layers
    const legend = new Legend({
      view: view,
      layerInfos: [
        {
          layer: Trails,
          title: "Trails"
        },
        {
          layer: POIlayer,
          title: "POIs"
        },
        {
          layer: ParkingLots,
          title: "Parking Lots"
        },
        {
          layer: StructurePolygon,
          title: "Structure Polygons"
        },
        {
          layer: Roads,
          title: "Roads"
        }
      ]
  });

    // Create expandable Legend widget
    let legendExpand = new Expand({
      expandIcon: "legend",
      view: view,         
      content: legend,  
      expanded: false
    });

    // Add Compass widget to bottom-right corner
    view.ui.add(compass, "bottom-right"); 
    
    // Add Home widget above zoom controls in top-left, and Locate button below
    view.ui.add(homeBtn, { position: "top-left", index: 0 });
    view.ui.add(locateBtn, { position: "top-left", index: 2 });
    
    // Add Legend to top-right corner
    view.ui.add(legendExpand, "top-right");

    // Add all layers to the map
    map.add(ParkBoundary);
    map.add(ParkingLots);
    map.add(Roads);
    map.add(StructurePolygon);
    map.add(Trails);
    map.add(POIlayer);
    map.add(Concerns);
    
    // Trail label visibility is controlled by the TrailLabelClass minScale property
    // Labels will only appear when the map scale is 1:500 or closer (zoomed in)
    
    // Season filter support for Trails layer
    // Filters Trails to show summer (Season 0 or 1) or winter (Season 0 or 2) trails
    const seasonFieldName = "Season";

    function setSeasonFilter(season) {
      // Build the filter expression for Season field (integer codes: 0=Both, 1=Summer, 2=Winter)
      const allowed = season.toLowerCase() === 'summer' ? '(0,1)' : '(0,2)';
      Trails.definitionExpression = `"${seasonFieldName}" IN ${allowed}`;
    }

    // After Trails layer loads, verify the Season field exists and wire up the toggle
    Trails.load().then(function() {
      const hasField = Trails.fields && Trails.fields.some(ff => ff.name === seasonFieldName);
      const checkbox = document.getElementById('seasonToggle');
      
      if (!hasField) {
        console.warn(`Field '${seasonFieldName}' not found on Trails layer; season toggle disabled.`);
        if (checkbox) checkbox.disabled = true;
        return;
      }
      
      // Initialize to Summer (unchecked) and wire the toggle to filter Trails
      if (checkbox) {
        checkbox.checked = false;
        setSeasonFilter('summer');
        checkbox.addEventListener('change', function() {
          const s = this.checked ? 'winter' : 'summer';
          setSeasonFilter(s);
        });
      }
    }).catch(function(err){
      console.error('Error loading Trails layer fields', err);
      const checkbox = document.getElementById('seasonToggle');
      if (checkbox) checkbox.disabled = true;
    });
    
  });
  </script>

</head>
<body>
   <div id="nav">  
      <div class="nav-left">
        <div class="brand-logo" aria-hidden="true">HC</div>
        <div class="brand-text">
          <div class="site-title">Highcliff State Park</div>
          <div class="site-sub">Trail Map</div>
        </div>
      </div>
      <div class="nav-right">
        <button id="aboutBtn" class="about-btn" aria-haspopup="dialog">About</button>
        <div class="season-toggle" title="Show Summer or Winter trails">
          <span class="toggle-label">Summer</span>
          <label class="switch">
            <input type="checkbox" id="seasonToggle" aria-label="Toggle season">
            <span class="slider"></span>
          </label>
          <span class="toggle-label">Winter</span>
        </div>
      </div>
   </div>  
  <!--Div to display the Map-->
  <div id="viewDiv"></div> 

  <!-- About panel -->
  <div id="aboutPanel" class="about-panel hidden" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="about-content">
      <button id="aboutClose" class="about-close" aria-label="Close about">Ã—</button>
      <h2 id="aboutTitle">About High Cliff Trails</h2>
      <div class="about-text">
        <p>High Cliff trails offer different levels of challenge to hikers. All trails are looped and vary in length. Use caution when on steep bluffs or near cliffs. Stay well away from cliffs that are not protected by a barricade or barrier. Stay on marked trails and behind barricades and barriers where they are provided. Watch small children closely. Trail surfaces can become slippery when wet, leaf covered, or where loose gravel may be encountered.</p>

        <p><strong>Butterfly Pond Trail</strong> (0.4-mile east loop and 0.7 mile west loop). The trail starts at the parking lot off Lower Cliff Road and goes around the Butterfly Pond. This interpretive trail is paved for accessibility and features wetland, prairie and forest ecosystems.</p>

        <p><strong>Forest Management Trail</strong> (0.9-mile short loop and 1.4-mile long loop). The trail starts at the parking lot east of the pavilion. This trail is marked with yellow dots and compares managed with unmanaged woodlots.</p>

        <p><strong>Horse/Bike Trail</strong> (7.5-mile). The parking lot for this trail system is located near the dump station (vehicles with trailers can park in the gravel horse parking lot). The horse/bike trail system is marked with orange dots and features grassland and hardwood forest ecosystems. Horse and bicycle rentals are not available.</p>

        <p><strong>Indian Mound Trail</strong> (0.6 mile). The trail starts at the Indian Mound lot off park road and near campsite #14 in the family campground. This self-guided, limestone-surfaced interpretive trail showcases effigy mounds built by Native Americans 1,500 years ago.</p>

        <p><strong>Lime Kiln Trail</strong> (0.9-mile short loop and 1.7-mile long loop). The trail starts at the paved parking lot near the lime kiln ruins and at the stairs near campsite #38. The trail is marked with blue dots and traverses part of the Niagara Escarpment State Natural Area. The lakeside segment of Lime Kiln Trail is generally level, while the escarpment segment involves steep climbs, descents and stairs.</p>

        <p><strong>Red Bird Trail</strong> (3.4-mile short loop and 3.8-mile long loop). The trail starts at the family campground, Indian Mounds trailhead and tower parking lot. This mostly level trail is marked with red dots and travels along the top of the Niagara Escarpment. It features panoramic views of Lake Winnebago, historical limestone quarries, the Chief Red Bird statue and the observation tower.</p>

        <p>The <strong>Overlook Trail</strong> is maintained as a ski trail when there is a volunteer available to groom it.</p>
      </div>
    </div>
  </div>

  <script>
    // About panel open/close handlers and keyboard/click-outside support
    (function(){
      const aboutBtn = document.getElementById('aboutBtn');
      const aboutPanel = document.getElementById('aboutPanel');
      const aboutClose = document.getElementById('aboutClose');
      
      function openAbout(){
        aboutPanel.classList.remove('hidden');
        aboutBtn.setAttribute('aria-expanded', 'true');
      }
      
      function closeAbout(){
        aboutPanel.classList.add('hidden');
        aboutBtn.setAttribute('aria-expanded', 'false');
      }
      
      // Open About panel on button click
      aboutBtn && aboutBtn.addEventListener('click', openAbout);
      
      // Close About panel on close button click
      aboutClose && aboutClose.addEventListener('click', closeAbout);
      
      // Close About panel on Escape key
      document.addEventListener('keydown', function(e){ 
        if (e.key === 'Escape') closeAbout(); 
      });
      
      // Close About panel when clicking outside content area
      aboutPanel && aboutPanel.addEventListener('click', function(e){ 
        if (e.target === aboutPanel) closeAbout(); 
      });
    })();
  </script>

</body>
</html>
