<!DOCTYPE html>
<html lang="en">
<head>
  <title>High Cliff State Park</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />
  
  <!-- Load custom styles, ArcGIS API dark theme, and ArcGIS JavaScript library v4.31 -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/dark/main.css">
  <script type="module" src="https://js.arcgis.com/calcite-components/3.3.3/calcite.esm.js"></script>
  <script src="https://js.arcgis.com/4.31/"></script>
  
<!--CSS to style the map view and position the navigation bar -->
  <style>
    html, body {
      margin: 0;
      height: 100%;
      width: 100%;
    }

    /* Top nav sits above the map */
    #nav {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      background: linear-gradient(180deg,#0b5aa5 0%, #0860a0 100%);
      color: #fff;
      z-index: 9999;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Make the map fill the area below the nav */
    #viewDiv {
      position: absolute;
      top: 64px; /* same as nav height */
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: auto;
    }
  </style>

<script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/widgets/Locate",
    "esri/widgets/Compass",
    "esri/widgets/ScaleBar",
    "esri/renderers/UniqueValueRenderer",
    "esri/widgets/Legend",
    "esri/widgets/Expand",
    "esri/widgets/Home",
    "esri/symbols/WebStyleSymbol",
    "esri/Basemap"
  ], function(Map, MapView, FeatureLayer, Locate, Compass, ScaleBar, UniqueValueRenderer, Legend, Expand, Home, WebStyleSymbol, Basemap) {
    
    // Load basemap from ArcGIS online portal
    const basemap = new Basemap({
      portalItem: {
        id: "dc9d20a9725c4ebaaa84da75a8bb0214",
      }
    });

    //Create a Map
    var map = new Map({
      basemap: basemap //Basemap layer
    });
    
    // Create the map view with center point and initial zoom level
    var view = new MapView({
      container: "viewDiv",
      map: map,
      center: [-88.29300, 44.1541],
      zoom: 14
    });
    
	  view.rotation = -15;

    // Create featurelayer from feature service 
  const POIlayer = new FeatureLayer({ 
    title: "POIs", 
    url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/2"
  });

    // Helper function to dynamically create popup templates for a layer
    // Selects a title field from candidates, excludes system fields (geometry, OBJECTID, Season),
    // and includes preferred fields in the popup (max 6 fields)
    function createPopupTemplate(layer, titleCandidates, preferredFields) {
      const excludeRe = /shape|geometry|globalid|objectid|season/i;
      layer.load().then(function() {
        const fields = layer.fields || [];

        // Find the best title field from candidates and preferred fields
        let titleField = null;
        for (let c of (titleCandidates || [])) {
          if (fields.some(f => f.name.toLowerCase() === c.toLowerCase() && !excludeRe.test(f.name))) { 
            titleField = c; 
            break; 
          }
        }
        if (!titleField && preferredFields && preferredFields.length) {
          const pf = preferredFields.find(p => fields.some(f => f.name.toLowerCase() === p.toLowerCase() && !excludeRe.test(f.name)));
          if (pf) titleField = pf;
        }
        if (!titleField) {
          const strField = fields.find(f => !excludeRe.test(f.name) && /char|string|text|name|title|label/i.test(f.type + ' ' + f.name));
          titleField = strField ? strField.name : (fields.find(f => !/objectid|season/i.test(f.name) && /objectid/i.test(f.name)) || {}).name || null;
        }

        // Build a list of fields to show in popup, prioritizing preferred fields and excluding system fields
        const visible = [];
        if (preferredFields && preferredFields.length) {
          for (let p of preferredFields) {
            const f = fields.find(ff => ff.name.toLowerCase() === p.toLowerCase());
                // Load basemap from ArcGIS online portal
                const basemap = new Basemap({
                  portalItem: {
                    id: "dc9d20a9725c4ebaaa84da75a8bb0214"
                  }
                });
            if (visible.some(v => v.fieldName === f.name)) continue;
            if (excludeRe.test(f.name)) continue;
            visible.push({ fieldName: f.name, label: f.alias || f.name });
            if (visible.length >= 6) break;
          }
        }

        layer.popupTemplate = {
          title: titleField ? `{${titleField}}` : layer.title || "Feature",
          content: [
            {
              type: "fields",
              fieldInfos: visible
            }
          ]
        };
      }).catch(function(err){
        console.warn('Unable to create popup for', layer && layer.title, err);
      });
    }

    // (removed unused test POI symbol variables)

  // Map of POI type codes to labels and colors for the renderer
    const poiSymbols = {
      0: { label: "Point of interest", name: "Point of interest"},
      1: { label: 'Picnic area', name: "Picnic area"},
      2: { label: 'Pet Picnic Area', name: "Pets on leash 1"},
      3: { label: 'Playground Equipment', name: "Playground"},
      4: { label: 'Community Fire Ring', name: "Campfire ring"},
      6: { label: 'Flush Toilets', name: "Flush toilet" },
      7: { label: 'Vault Toilets', name: "Vault Toilet" },
      8: { label: 'Showers', name: "Showers" },
      9: { label: 'Trailer Dumping Station', name: "Trailer site" },
      10: { label: 'Water Fountain', name: "Water hookup" },
      11: { label: 'Scenic Overlook', name: "Viewing area" },
      12: { label: 'Emergency Access', name: "SafetyCautionAlerts" },
      13: { label: 'Park Buildings', name: "Visitor center" }
    };  

    // POI Label Symbol
    const poiLabelSymbol = {
      type: "text",
      color: "#333",
      font: {
        size: 9,
        family: "Arial",
        weight: "bold"
      }
    };

    // POI Label Class - only label features that have a non-empty Name
    const poiLabelClass = {
      symbol: poiLabelSymbol,
      labelExpressionInfo: {
        expression: "IIF(IsEmpty(Trim($feature.Name)), '', $feature.Name)"
      },
      labelPlacement: "above-center",
      where: "Name IS NOT NULL AND Name <> ''"
    };

    POIlayer.load().then(function() {
      // Find the POI type field
      const field = (POIlayer.fields || []).find(f => /type|category|poi|class/i.test(f.name));
      const fieldName = field ? field.name : 'Type';

      // Show POIs only when zoomed in at least 2 levels from initial (14 → 16+)
      const INITIAL_ZOOM = 14;
      const POI_MIN_ZOOM = INITIAL_ZOOM + 2;
      POIlayer.visible = false; // Start hidden
      view.watch('zoom', function(z){
        POIlayer.visible = z >= POI_MIN_ZOOM;
      });

      // Create unique value infos from the POI color map
      const uniqueInfos = Object.keys(poiSymbols).map(function(key) {
        const info = poiSymbols[key];
        return {
          value: Number(key),
          label: info.label,
          // Use WebStyleSymbol correctly for 2D point symbols
          symbol: new WebStyleSymbol({
            name: info.name,
            styleUrl: "https://cdn.arcgis.com/sharing/rest/content/items/36359a4a8f3143b6bf44d5688e007900/data"
          })
        };
      });

      const poiRenderer = new UniqueValueRenderer({
        field: fieldName,
        defaultLabel: 'Other POI',
        uniqueValueInfos: uniqueInfos
      });

      // Apply renderer, enable labels, and create popup template for POI layer
      POIlayer.renderer = poiRenderer;
      POIlayer.labelingInfo = [poiLabelClass];
      POIlayer.labelsEnabled = true;
      try { POIlayer.refresh(); } catch (e) { /* ignore if not applicable */ }

      // Define a custom popup directly for POI layer (Name, Type, Description, Notes)
      POIlayer.popupTemplate = {
        title: "{Name}",
        content: [
          {
            type: "fields",
            fieldInfos: [
              { fieldName: "Name", label: "Name" },
              { fieldName: fieldName, label: "Type" },
              { fieldName: "Description", label: "Description" },
              { fieldName: "Notes", label: "Notes" }
            ].filter(function(fi){ return !!fi.fieldName; })
          }
        ]
      };
    }).catch(function(err){
      console.error('Error loading POI layer to set color renderer', err);
    });

    const TrailsRenderer = new UniqueValueRenderer({
      field: "TrailType",
      defaultLabel: "Other",
      defaultSymbol: {
        type: "simple-line",
        color: [150, 150, 150, 1],
        width: 1.5
      },
      uniqueValueInfos: [
      {
        value: "0",
        label: "Hiking Trails",
        symbol: {
          type: "simple-line",
          color: [0,255,0,1],
          width: 1.5,
          style: "short-dash"
        },
      },
      {
        value: "1",
        label: "Hiking/Biking Trails",
        symbol: {
          type: "simple-line",
          color: [255,0,0,1],
          width: 1.5,
          style: "short-dash"
        }
      },
      {
        value: "2",
        label: "Horse/Biking Trails",
        symbol: {
          type: "simple-line",
          color: [255,200,0,1],
          width: 1.5,
          style: "short-dash"
        }
      },
      {
        value: "3",
        label: "Cross Country Skiing Trails",
        symbol: {
          type: "simple-line",
          color: [0,0,255,1],
          width: 1.5,
          style: "short-dash"
        }
      },
      {
        value: "4",
        label: "Access Trails",
        symbol: {
          type: "simple-line",
          color: [125,125,125,1],
          width: 1.5,
          style: "short-dash"
        }
      },
      {
        value: "5",
        label: "Snowmobile Trails",
        symbol: {
          type: "simple-line",
          color: [0,0,0,1],
          width: 1.5,
          style: "short-dash"
        }
      }
    ]}
    );


    const TrailLabelSymbol = {
    type: "text",
    color: "black",
    haloColor: "white",
    haloSize: "1px",
    font: {
      size: 9,
      family: "Arial"
    },
    weight: "bold"
  };

  // Label class for trails with spacing and scale constraints
  const TrailLabelClass = {
    symbol: TrailLabelSymbol,
    labelExpressionInfo: {
      expression: "$feature.Name + ' ' + Round($feature.Miles, 2) + ' Mi'"
    },
    labelPlacement: "above-along",
    repeatLabel: false,
    deconflictionStrategy: "dynamic",
    repeatDistance: 1609, // Prevent labels within 1 mile (1609 meters) of each other
    maxScale: 500, // Show labels when zoomed to 1:500 or closer
    minScale: 0 // No minimum scale limit
  };
  
    const Trails = new FeatureLayer({ 
    // URL to the service
        title: "Trails", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/3",
        renderer: TrailsRenderer,
        outFields: ["*"],
        labelingInfo: [TrailLabelClass],
        labelsEnabled: true,   
        popupTemplate: {
                  title: "{Name}",
                  content: [
                    {
                      type: "text",
                      text: "<b>Type:</b> {TrailType}<br><b>Miles:</b> {expression/milesRounded}"
                    }
                  ],
                  expressionInfos: [
                    {
                      name: "milesRounded",
                      expression: "Round($feature.Miles, 2)"
                    }
                  ]
                }
            });

    const roadRenderer = new UniqueValueRenderer({
      field: "RoadType",
      defaultLabel: "Other",
      defaultSymbol: {
        type: "simple-line",
        color: [150, 150, 150, 1],
        width: 1.5
      },
      uniqueValueInfos: [
      {
        value: "0",
        label: "Park Roads",
        symbol: {
          type: "simple-line",
          color: [0,0,0,.5],
          width: 2
        },
      },
      {
        value: "1",
        label: "Service Roads",
        symbol: {
          type: "simple-line",
          color: [255,0,0,.25],
          width: 2
        }
      },
      {
        value: "2",
        label: "Campground Roads",
        symbol: {
          type: "simple-line",
          color: [125,125,125,.25],
          width: 2
        }
      },
      {
        value: "4",
        label: "Not Park Roads",
        symbol: {
          type: "simple-line",
          color: [100,100,100,.25],
          width: 2
        }
      }]
    });

    const roadLabelSymbol = {
      type: "text",
      color: "#333",
      haloColor: "#fff",
      haloSize: "1px",
      font: {
        size: 9,
        family: "Arial"
      }
    };

    // Label class for roads (excludes RoadType 4 - Not Park Roads)
    const roadLabelClass = {
      symbol: roadLabelSymbol,
      labelExpressionInfo: {
        expression: "$feature.Name"
      },
      labelPlacement: "above-along",
      where: "RoadType <> 4"
    };

    // Load Roads feature layer from ArcGIS service with labeling
    const Roads = new FeatureLayer({
        title: "Roads", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/ParkRoads_view/FeatureServer",
        renderer: roadRenderer,
        outFields: ["*"],
        labelingInfo: [roadLabelClass],
        labelsEnabled: true
    });
    // Concerns layer (reported issues) using a web style symbol
    const concernSymbol = new WebStyleSymbol({
      name: "Fire Response Restrictions - Other",
      styleUrl: "https://cdn.arcgis.com/sharing/rest/content/items/6eeef46c653b40c9bda04f9bed913b70/data"
    });
    
    const concernRenderer = { type: "simple", symbol: concernSymbol };

    const Concerns = new FeatureLayer({
      title: "Concerns",
      url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/survey123_a555a6a5147e4d33bf61e1214d88d268_results/FeatureServer",
      renderer: concernRenderer,
      outFields: ["*"],
      popupTemplate: {
        title: "{Name}",
        content: [{
          type: "fields",
          fieldInfos: [
            { fieldName: "type_of_concern", label: "Type" },
            { fieldName: "additional_notes_for_park_staff", label: "Notes" }
          ]
        }]
      }
    });

    // (Duplicate Roads and Concerns layer blocks removed)

    // Define the fill symbol for parking lots (gray with black outline)
    const ParkingfillSymbol = {
      type: "simple-fill",
      color: [128, 128, 128, 0.75],
      outline: {
        color: [0, 0, 0, 0.75],
        width: 0.5
      }
    };

    // Define the renderer for parking lots
    const ParkingRenderer = {
      type: "simple",
      symbol: ParkingfillSymbol
    };

    // Load Parking Lots feature layer from ArcGIS service
    const ParkingLots = new FeatureLayer({
        title: "Parking Lots", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/0",
        renderer: ParkingRenderer      
    });

    // Define the fill symbol for park boundary (transparent with bold purple outline for contrast)
    const ParkfillSymbol = {
      type: "simple-fill",	  // autocasts as new SimpleFillSymbol()
	    style: "none",
      outline: {
        color: [128, 0, 128, 1], // Purple outline
        width: 3
      }
    };
    
    // Define the renderer for park boundary
    const ParkBoundaryRenderer = {
      type: "simple",
      symbol: ParkfillSymbol
    };    
    
    // Load Park Boundary feature layer from ArcGIS service
    const ParkBoundary = new FeatureLayer({
        title: "Park Boundary", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/4",
        renderer: ParkBoundaryRenderer
    });
    
    // Load Structure Polygons feature layer from ArcGIS service
    const StructurePolygon = new FeatureLayer({
        title: "Structure Polygons", 
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/HighCliffStatePark_view/FeatureServer/1",
            
    });    

    const HydrologyRenderer = {
      type: "simple", // autocasts as new SimpleRenderer()
      symbol: {
        type: "simple-fill",	  // autocasts as new SimpleFillSymbol()
        color: [0, 162, 232, .5],
        outline: {
          color: [0, 0, 128, .5], // Dark blue outline
          width: 1
        }
      }
    };	

  const Water = new FeatureLayer({ 
    // URL to the service
        title: "Hydrology", 
        url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/AreaHydrology/FeatureServer",
        renderer: HydrologyRenderer   
    });       

    // Create popup template for Structure Polygons with selected fields
    createPopupTemplate(StructurePolygon, ['Name','Title','Label','OBJECTID'], ['Name','Type','Material','YearBuilt','Condition']);
    
    // Create Locate widget to find user's current location
    const locateBtn = new Locate({
      view: view
    });

    // Create Compass widget to display map orientation
    const compass = new Compass({
      view: view
    });

    // Create and add Scale Bar widget showing imperial and metric units
    const scaleBar = new ScaleBar({
      view: view,
      unit: "imperial"
    });
    view.ui.add(scaleBar, "bottom-left");

    // Create Home widget to return to the initial map extent
    const homeBtn = new Home({
      view: view
    });

    // Create Legend widget showing all map layers
    const legend = new Legend({
      view: view,
      layerInfos: [
        {
          layer: Trails,
          title: "Trails"
        },
        {
          layer: POIlayer,
          title: "POIs"
        },
        {
          layer: ParkingLots,
          title: "Parking Lots"
        },
        {
          layer: StructurePolygon,
          title: "Structure Polygons"
        },
        {
          layer: Roads,
          title: "Roads"
        },
        {
          layer: Concerns,
          title: "Concerns"
        }
      ]
  });

    // Create expandable Legend widget
    let legendExpand = new Expand({
      expandIcon: "legend",
      view: view,         
      content: legend,  
      expanded: false
    });

  

  // Add the Compass widget to the bottom-right corner of the view
  view.ui.add(compass, "bottom-right"); 
	
  // Place Home above the built-in zoom controls in the top-left, then zoom, then our locate button
  view.ui.add(homeBtn, { position: "top-left", index: 0 });
  view.ui.add(locateBtn, { position: "top-left", index: 2 });
	
  // Add the legend to the bottom right corner of the view
  view.ui.add(legendExpand, "top-left");

  // add layer to the map
  // Add layers once (removed duplicates)
  map.add(Water);
  map.add(ParkBoundary);
  map.add(ParkingLots);
  map.add(Roads);
  map.add(StructurePolygon);
  map.add(Trails);
  map.add(POIlayer);
  map.add(Concerns);
    
    // Trail label visibility is controlled by the TrailLabelClass minScale property
    // Labels will only appear when the map scale is 1:500 or closer (zoomed in)
    
    // Season filter support for Trails layer
    // Filters Trails to show summer (Season 0 or 1) or winter (Season 0 or 2) trails
    const seasonFieldName = "Season";

    function setSeasonFilter(season) {
      // Build the filter expression for Season field (integer codes: 0=Both, 1=Summer, 2=Winter)
      const allowed = season.toLowerCase() === 'summer' ? '(0,1)' : '(0,2)';
      Trails.definitionExpression = `"${seasonFieldName}" IN ${allowed}`;
    }

    // After Trails layer loads, verify the Season field exists and wire up the toggle
    Trails.load().then(function() {
      const hasField = Trails.fields && Trails.fields.some(ff => ff.name === seasonFieldName);
      const checkbox = document.getElementById('seasonToggle');
      
      if (!hasField) {
        console.warn(`Field '${seasonFieldName}' not found on Trails layer; season toggle disabled.`);
        if (checkbox) checkbox.disabled = true;
        return;
      }
      
      // Initialize to Summer (unchecked) and wire the toggle to filter Trails
      if (checkbox) {
        checkbox.checked = false;
        setSeasonFilter('summer');
        checkbox.addEventListener('change', function() {
          const s = this.checked ? 'winter' : 'summer';
          setSeasonFilter(s);
        });
      }
    }).catch(function(err){
      console.error('Error loading Trails layer fields', err);
      const checkbox = document.getElementById('seasonToggle');
      if (checkbox) checkbox.disabled = true;
    });
    
  });
  </script>

</head>
<body>
   <div id="nav">  
      <div class="nav-left">
        <div class="brand-logo" aria-hidden="true">HC</div>
        <div class="brand-text">
          <div class="site-title">Highcliff State Park</div>
          <div class="site-sub">Trail Map</div>
        </div>
      </div>
      <div class="nav-right">
        <button id="aboutBtn" class="about-btn" aria-haspopup="dialog">About</button>
        <div class="season-toggle" title="Show Summer or Winter trails">
          <span class="toggle-label">Summer</span>
          <label class="switch">
            <input type="checkbox" id="seasonToggle" aria-label="Toggle season">
            <span class="slider"></span>
          </label>
          <span class="toggle-label">Winter</span>
        </div>
      </div>
   </div>  
  <!--Div to display the Map-->
  <div id="viewDiv"></div> 

  <!-- Report Concern Button -->
  <button id="reportConcernBtn" class="report-concern-btn" title="Report a concern about the park">Report a Concern</button>

  <!-- About panel -->
  <div id="aboutPanel" class="about-panel hidden" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="about-content">
      <button id="aboutClose" class="about-close" aria-label="Close about">×</button>
      <h2 id="aboutTitle">About High Cliff Trails</h2>
      <div class="about-text">
        <p>High Cliff trails offer different levels of challenge to hikers. All trails are looped and vary in length. Use caution when on steep bluffs or near cliffs. Stay well away from cliffs that are not protected by a barricade or barrier. Stay on marked trails and behind barricades and barriers where they are provided. Watch small children closely. Trail surfaces can become slippery when wet, leaf covered, or where loose gravel may be encountered.</p>

        <p><strong>Butterfly Pond Trail</strong> (0.4-mile east loop and 0.7 mile west loop). The trail starts at the parking lot off Lower Cliff Road and goes around the Butterfly Pond. This interpretive trail is paved for accessibility and features wetland, prairie and forest ecosystems.</p>

        <p><strong>Forest Management Trail</strong> (0.9-mile short loop and 1.4-mile long loop). The trail starts at the parking lot east of the pavilion. This trail is marked with yellow dots and compares managed with unmanaged woodlots.</p>

        <p><strong>Horse/Bike Trail</strong> (7.5-mile). The parking lot for this trail system is located near the dump station (vehicles with trailers can park in the gravel horse parking lot). The horse/bike trail system is marked with orange dots and features grassland and hardwood forest ecosystems. Horse and bicycle rentals are not available.</p>

        <p><strong>Indian Mound Trail</strong> (0.6 mile). The trail starts at the Indian Mound lot off park road and near campsite #14 in the family campground. This self-guided, limestone-surfaced interpretive trail showcases effigy mounds built by Native Americans 1,500 years ago.</p>

        <p><strong>Lime Kiln Trail</strong> (0.9-mile short loop and 1.7-mile long loop). The trail starts at the paved parking lot near the lime kiln ruins and at the stairs near campsite #38. The trail is marked with blue dots and traverses part of the Niagara Escarpment State Natural Area. The lakeside segment of Lime Kiln Trail is generally level, while the escarpment segment involves steep climbs, descents and stairs.</p>

        <p><strong>Red Bird Trail</strong> (3.4-mile short loop and 3.8-mile long loop). The trail starts at the family campground, Indian Mounds trailhead and tower parking lot. This mostly level trail is marked with red dots and travels along the top of the Niagara Escarpment. It features panoramic views of Lake Winnebago, historical limestone quarries, the Chief Red Bird statue and the observation tower.</p>

        <p>The <strong>Overlook Trail</strong> is maintained as a ski trail when there is a volunteer available to groom it.</p>
      </div>
    </div>
  </div>

  <script>
    // About panel open/close handlers and keyboard/click-outside support
    (function(){
      const aboutBtn = document.getElementById('aboutBtn');
      const aboutPanel = document.getElementById('aboutPanel');
      const aboutClose = document.getElementById('aboutClose');
      
      function openAbout(){
        aboutPanel.classList.remove('hidden');
        aboutBtn.setAttribute('aria-expanded', 'true');
      }
      
      function closeAbout(){
        aboutPanel.classList.add('hidden');
        aboutBtn.setAttribute('aria-expanded', 'false');
      }
      
      // Open About panel on button click
      aboutBtn && aboutBtn.addEventListener('click', openAbout);
      
      // Close About panel on close button click
      aboutClose && aboutClose.addEventListener('click', closeAbout);
      // close on escape
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeAbout(); });
      // close when clicking outside content
      aboutPanel && aboutPanel.addEventListener('click', function(e){ if (e.target === aboutPanel) closeAbout(); });
    })();

    // Report Concern button handler
    (function(){
      const reportBtn = document.getElementById('reportConcernBtn');
      reportBtn && reportBtn.addEventListener('click', function(){
        window.open('https://arcg.is/10ya4y2', '_blank');
      });
    })();
  </script>

</body>
</html>